/*!
 * WSTester v1.0
 * WebSocket Testing Engine is JavaScript library for unit testing of websystems with WebSockets.
 *
 * Copyright AivanF. 2018 - All Rights Reserved.
 * E-mail: aivanf@mail.ru
 * Website: www.aivanf.com
 * GitHub: https://github.com/AivanF/WSTester

 * This software is provided 'as-is', without any express or implied warranty.
 * You may not hold the author liable.

 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it freely,
 * subject to the following restrictions:

 * The origin of this software must not be misrepresented. You must not claim
 * that you wrote the original software. When use the software, you must give
 * appropriate credit, provide a link to the original file, and indicate if changes were made.
 * This notice may not be removed or altered from any source distribution.
 */
 
var WSTester=function(t){function i(t){return"number"==typeof t&&isFinite(t)?t>0:!!t}function n(t){return t.length>s?t.substring(0,e)+"...":t}var s=256,e=192,o=function(t){this.server=null,this.current_flow=0,this.current_unit=1,this.next_unit=null,this.working=!1,this.waiting_time=2e3,this.delay=0,this.timer=null,this.flows=[],this.add=function(t,i){},this.hws=null,this.pass_count=0,this.fail_count=0,this.work_begin=function(){},this.work_end=function(t,i,n){},this.split=!1;for(var i=["waiting_time","add","flows","delay","work_begin","work_end","split"],n=0;n<i.length;n++){var s=i[n];s in t&&(this[s]=t[s])}};o.prototype.flow_name=function(){return this.current_flow<this.flows.length?this.islist()?"<b>[ "+this.flows[this.current_flow][0]+" ]</b>":"<b>{ "+this.flows[this.current_flow][0]+" }</b>":"[?]"},o.prototype.islist=function(){return this.flows[this.current_flow]instanceof Array},o.prototype.stop_timer=function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},o.prototype.upload=function(t){if(t){t instanceof Array||(t=[t]);for(var i=0;i<t.length;i++){var n=JSON.stringify(t[i]);this.add("- Sent data:",1),this.add(n,1),this.hws.send(n)}}},o.prototype.process_flow=function(){if(this.current_flow<this.flows.length)this.add("- Flow "+this.flow_name()+" is started."),this.current_unit=1,this.process_unit();else{this.add("<b>- Flows results:</b>");var t=0;this.pass_count>0&&(t=2),this.add("* Pass count: "+this.pass_count,t),t=0,this.fail_count>0&&(t=3),this.add("* Fail count: "+this.fail_count,t),t=0,this.flows.length!=this.fail_count+this.pass_count&&(t=3),this.add("* Missed count: "+(this.flows.length-this.fail_count-this.pass_count),t),this.finish()}},o.prototype.next_flow=function(){this.stop_timer(),this.current_flow++,this.split?(this.stop_timer(),this.working=!1,this.hws.onmessage=function(){},this.hws.close(),this.add("<br><hr>"),this.setup(this.server)):(this.add("<br><hr>"),this.process_flow())},o.prototype.process_unit=function(){var t=!1;if(this.islist()?(t=this.current_unit<this.flows[this.current_flow].length,t||this.add("- Flow "+this.flow_name()+" is completed.")):(t=!!this.current_unit,t?(t=!!this.flows[this.current_flow][this.current_unit],t||this.add("- Flow "+this.flow_name()+' got undefined continue "'+this.current_unit+'"')):this.add("- Flow "+this.flow_name()+" got no continue.")),t){var i=this.flows[this.current_flow][this.current_unit];if(i.task){var n="- Execution of #"+this.current_unit;i.title&&(n+=' "'+i.title+'"'),this.add(n);var s={},e=i.task(this.hws,s);s.next?this.next_unit=s.next:this.islist()?this.next_unit=this.current_unit+1:this.next_unit=null,this.upload(e);var o=this;this.timer=setTimeout(function(){o.working?(o.fail_count++,o.add("- Waiting time is up! ",3),o.next_flow()):o.add("- Bad timer...",3)},this.waiting_time)}else i.enter?(this.next_unit=i.enter({}),this.next_unit!=this.current_unit?(this.current_unit=this.next_unit,this.next_unit=null,this.process_unit()):this.add("- Recursive units indices!",3)):(this.fail_count++,this.add("- Wrong unit! ",3),this.next_flow())}else this.pass_count++,this.next_flow()},o.prototype.finish=function(){this.stop_timer(),this.hws&&(this.hws.close(),this.hws=null),this.working=!1,this.work_end(this.pass_count,this.fail_count,this.flows.length)},o.prototype.setup=function(t){this.server=t,this.hws=new WebSocket(t);var s=this;s.hws.onopen=function(){s.add("- Connection established."),s.working=!0,0==s.current_flow&&s.work_begin(),s.process_flow()},s.hws.onmessage=function(t){var e=JSON.parse(t.data);s.add("- Got:",1),s.add(n(t.data),1);var o=s.flows[s.current_flow][s.current_unit],r=!1;if(o.condition){var h=o.condition(e);"boolean"==typeof h&&h?(r=!0,s.add("- By condition with boolean as result",1)):"number"==typeof h?(r=!0,s.add("- By condition with unit index as result",1),s.next_unit=h):"string"==typeof h&&(r=!0,s.add("- By condition with unit name as result",1),s.next_unit=h)}if(!r&&void 0!==o.key)if(void 0!==o.val)if(o.val instanceof Array){s.add("- Try by data[key]==val[i]",1);for(var u=0;u<o.val.length;u++)if(e[o.key]==o.val[u]){r=!0,s.add("- By data[key]==val[i]",1);break}}else e[o.key]==o.val&&(r=!0,s.add("- By data[key]==val",1));else i(e[o.key])&&(r=!0,s.add("- By true key",1));r?(s.add("- Succeeded.",2),s.stop_timer(),o.finalise&&s.upload(o.finalise(s.hws)),s.current_unit=s.next_unit,s.next_unit=null,s.delay>50?setTimeout(function(){s.process_unit()},s.delay):s.process_unit()):(s.add("- Got irrelevent data:",3),s.add(n(t.data),3))},s.hws.onclose=function(t){s.working?(s.add("- The connection was closed!",3),s.finish()):s.add("- The connection was closed.")},s.hws.onerror=function(t){s.add("- An error happened!",3),s.finish()}},o.prototype.abort=function(){this.add=function(){},this.work_end=function(){},this.finish()};var r=function(t){var i=new o(t);return t.server&&i.setup(t.server),i},h={};return h.Controller=r,h}(window);