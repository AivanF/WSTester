/*!
 * WSTester v1.0
 * WebSocket Testing Engine is JavaScript library for unit testing of websystems with WebSockets.
 *
 * Copyright AivanF. 2018 - All Rights Reserved.
 * E-mail: aivanf@mail.ru
 * Website: www.aivanf.com
 * GitHub: https://github.com/AivanF/WSTester

 * This software is provided 'as-is', without any express or implied warranty.
 * You may not hold the author liable.

 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it freely,
 * subject to the following restrictions:

 * The origin of this software must not be misrepresented. You must not claim
 * that you wrote the original software. When use the software, you must give
 * appropriate credit, provide a link to the original file, and indicate if changes were made.
 * This notice may not be removed or altered from any source distribution.
 */
 
var WSTester=function(t){var i=256,n=192;function s(t){return t.length>i?t.substring(0,n)+"...":t}var e=function(t){this.server=null,this.current_flow=0,this.current_unit=1,this.next_unit=null,this.working=!1,this.waiting_time=2e3,this.delay=0,this.timer=null,this.flows=[],this.add=function(t,i){},this.hws=null,this.pass_count=0,this.fail_count=0,this.work_begin=function(){},this.work_end=function(t,i,n){},this.split=!1;for(var i=["waiting_time","add","flows","delay","work_begin","work_end","split"],n=0;n<i.length;n++){var s=i[n];s in t&&(this[s]=t[s])}};e.prototype.flow_name=function(){return this.current_flow<this.flows.length?this.islist()?"<b>[ "+this.flows[this.current_flow][0]+" ]</b>":"<b>{ "+this.flows[this.current_flow][0]+" }</b>":"[?]"},e.prototype.islist=function(){return this.flows[this.current_flow]instanceof Array},e.prototype.stop_timer=function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},e.prototype.upload=function(t){if(t){t instanceof Array||(t=[t]);for(var i=0;i<t.length;i++){var n=JSON.stringify(t[i]);this.add("- Sent data:",1),this.add(n,1),this.hws.send(n)}}},e.prototype.process_flow=function(){if(this.current_flow<this.flows.length)this.add("- Flow "+this.flow_name()+" is started."),this.current_unit=1,this.process_unit();else{this.add("<b>- Flows results:</b>");var t=0;this.pass_count>0&&(t=2),this.add("* Pass count: "+this.pass_count,t),t=0,this.fail_count>0&&(t=3),this.add("* Fail count: "+this.fail_count,t),t=0,this.flows.length!=this.fail_count+this.pass_count&&(t=3),this.add("* Missed count: "+(this.flows.length-this.fail_count-this.pass_count),t),this.finish()}},e.prototype.next_flow=function(){this.stop_timer(),this.current_flow++,this.split?(this.stop_timer(),this.working=!1,this.hws.onmessage=function(){},this.hws.close(),this.add("<br><hr>"),this.setup(this.server)):(this.add("<br><hr>"),this.process_flow())},e.prototype.process_unit=function(){var t=!1;if(this.islist()?(t=!!this.flows[this.current_flow][this.current_unit])||(this.current_unit==this.flows[this.current_flow].length?this.add("- Flow "+this.flow_name()+" is completed."):this.add("- Warning: Flow "+this.flow_name()+' got undefined continue "'+this.current_unit+'"')):(t=!!this.current_unit)?(t=!!this.flows[this.current_flow][this.current_unit])||this.add("- Flow "+this.flow_name()+' got undefined continue "'+this.current_unit+'"'):this.add("- Flow "+this.flow_name()+" got no continue."),t){var i=this.flows[this.current_flow][this.current_unit];if(i.task){var n="- Execution of #"+this.current_unit;i.title&&(n+=' "'+i.title+'"'),this.add(n);var s={},e=i.task(this.hws,s);s.next?this.next_unit=s.next:this.islist()?this.next_unit=this.current_unit+1:this.next_unit=null,this.upload(e);var o=this;this.timer=setTimeout(function(){o.working?(o.fail_count++,o.add("- Waiting time is up! ",3),o.next_flow()):o.add("- Bad timer...",3)},this.waiting_time)}else i.enter?(this.next_unit=i.enter(),this.next_unit==this.current_unit&&this.add("- Warning: Recursive units indices!",3),this.current_unit=this.next_unit,this.next_unit=null,this.process_unit()):(this.fail_count++,this.add("- Wrong unit! ",3),this.next_flow())}else this.pass_count++,this.next_flow()},e.prototype.finish=function(){this.stop_timer(),this.hws&&(this.hws.close(),this.hws=null),this.working=!1,this.work_end(this.pass_count,this.fail_count,this.flows.length)},e.prototype.setup=function(t){this.server=t,this.hws=new WebSocket(t);var i=this;i.hws.onopen=function(){i.add("- Connection established."),i.working=!0,0==i.current_flow&&i.work_begin(),i.process_flow()},i.hws.onmessage=function(t){var n=JSON.parse(t.data);i.add("- Got:",1),i.add(s(t.data),1);var e=i.flows[i.current_flow][i.current_unit],o=!1;if(e){if(e.condition){var r=e.condition(n);"boolean"==typeof r&&r?(o=!0,i.add("- By condition with boolean as result",1)):"number"==typeof r?(o=!0,i.add("- By condition with unit index as result",1),i.next_unit=r):"string"==typeof r&&(o=!0,i.add("- By condition with unit name as result",1),i.next_unit=r)}if(!o&&void 0!==e.key)if(void 0!==e.val)if(e.val instanceof Array){i.add("- Try by data[key]==val[i]",1);for(var h=0;h<e.val.length;h++)if(n[e.key]==e.val[h]){o=!0,i.add("- By data[key]==val[i]",1);break}}else n[e.key]==e.val&&(o=!0,i.add("- By data[key]==val",1));else("number"==typeof(u=n[e.key])&&isFinite(u)?u>0:u)&&(o=!0,i.add("- By true key",1));var u;o?(i.add("- Succeeded.",2),i.stop_timer(),e.finalise&&i.upload(e.finalise(i.hws)),i.current_unit=i.next_unit,i.next_unit=null,i.delay>50?setTimeout(function(){i.process_unit()},i.delay):i.process_unit()):(i.add("- Got irrelevent data:",3),i.add(s(t.data),3))}},i.hws.onclose=function(t){i.working?(i.add("- The connection was closed!",3),i.finish()):i.add("- The connection was closed.")},i.hws.onerror=function(t){i.add("- An error happened!",3),i.finish()}},e.prototype.abort=function(){this.add=function(){},this.work_end=function(){},this.finish()};var o={Controller:function(t){var i=new e(t);return t.server&&i.setup(t.server),i}};return o}(window);